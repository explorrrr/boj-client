name: Release and Publish

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Crate version to publish (must match Cargo.toml)"
        required: true
        type: string
      dry_run:
        description: "Run release gate only (skip crates.io publish)"
        required: true
        type: boolean
        default: true

concurrency:
  group: release-publish
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  validate_version:
    name: Validate version input
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}

    steps:
      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Ensure workflow runs from master
        shell: bash
        run: |
          set -euo pipefail
          if [ "${GITHUB_REF_NAME}" != "master" ]; then
            echo "This workflow must be dispatched on master."
            exit 1
          fi

      - name: Validate input version and Cargo.toml version
        id: validate
        shell: bash
        run: |
          set -euo pipefail

          input_version="${{ inputs.version }}"
          version_pattern='^[0-9]+\.[0-9]+\.[0-9]+([-.][0-9A-Za-z.]+)?$'
          if ! printf '%s\n' "${input_version}" | grep -Eq "${version_pattern}"; then
            echo "Invalid version format: ${input_version}"
            exit 1
          fi

          cargo_version="$(sed -nE 's/^version = "([^"]+)"$/\1/p' Cargo.toml | head -n 1)"
          if [ -z "${cargo_version}" ]; then
            echo "Failed to resolve crate version from Cargo.toml."
            exit 1
          fi

          if [ "${input_version}" != "${cargo_version}" ]; then
            echo "Version mismatch: input=${input_version}, cargo=${cargo_version}"
            exit 1
          fi

          echo "version=${input_version}" >> "${GITHUB_OUTPUT}"

      - name: Write workflow summary
        shell: bash
        run: |
          {
            echo "## Release Publish Validation"
            echo "- target branch: \`master\`"
            echo "- requested version: \`${{ inputs.version }}\`"
            echo "- Cargo.toml version: \`${{ steps.validate.outputs.version }}\`"
            echo "- dry run: \`${{ inputs.dry_run }}\`"
          } >> "${GITHUB_STEP_SUMMARY}"

  verify_release_gate:
    name: Verify release gate
    runs-on: ubuntu-latest
    needs: validate_version

    steps:
      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: cargo fmt
        run: cargo fmt --all -- --check

      - name: cargo clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: cargo doc (warnings denied)
        run: RUSTDOCFLAGS='-D warnings' cargo doc --workspace --no-deps

      - name: cargo test --doc
        run: cargo test --doc --workspace

      - name: cargo test
        run: cargo test --workspace --all-targets

      - name: Live BOJ API contract test
        env:
          BOJ_CONTRACT_TEST: "1"
        run: cargo test --test contract_nightly -- --ignored

      - name: cargo publish dry-run
        run: cargo publish --dry-run

  publish_crate:
    name: Publish crate
    runs-on: ubuntu-latest
    needs: [validate_version, verify_release_gate]
    if: ${{ !inputs.dry_run }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout master with full history
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Authenticate to crates.io (trusted publishing)
        id: auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
        run: cargo publish

      - name: Write publish summary
        shell: bash
        run: |
          {
            echo "## crates.io Publish"
            echo "- published version: \`${{ needs.validate_version.outputs.version }}\`"
            echo "- trusted publishing: enabled"
          } >> "${GITHUB_STEP_SUMMARY}"
