# II. リクエストについて

## 1. リクエストURL の構成
> 出典: api_manual.pdf p.4

各APIのリクエストURLは以下の通りです。APIエンドポイント（`?<パラメータ>` より前）は固定で、大文字小文字を区別します。

- コードAPI: `https://www.stat-search.boj.or.jp/api/v1/getDataCode?<パラメータ>`
- 階層API: `https://www.stat-search.boj.or.jp/api/v1/getDataLayer?<パラメータ>`
- メタデータAPI: `https://www.stat-search.boj.or.jp/api/v1/getMetadata?<パラメータ>`

## 2. パラメータの設定
> 出典: api_manual.pdf p.4

パラメータは `パラメータ名=値` の形式で指定し、複数指定時は `&` で連結します。

- 形式: `パラメータ名=値&パラメータ名=値&...`
- パラメータ名および値は大文字小文字を区別しません。
- 複数パラメータの並び順は順不同です。

例（コードAPI）:

`format=json&lang=jp&db=CO&startDate=202401&endDate=202504&code=TK99F1000601GCQ01000,TK99F2000601GCQ01000`

例（階層API）:

`lang=en&db=md10&frequency=q&layer=*&startPosition=255`

例（メタデータAPI）:

`format=csv&lang=jp&db=fm08`

## 3. パラメータの解説
> 出典: api_manual.pdf p.5-p.8

### (1) パラメータ一覧

| パラメータ名 | 設定内容 | 設定値 | コードAPI | 階層API | メタデータAPI |
|---|---|---|---|---|---|
| FORMAT | 結果ファイル形式 | JSON または CSV※3 | 任意 | 任意 | 任意 |
| LANG | 言語 | 日本語: JP、英語: EN | 任意 | 任意 | 任意 |
| DB | DB名 | DB名※4 | 必須 | 必須 | 必須 |
| CODE | 系列コード | 系列コード※5（カンマ区切りで複数指定可、同じ期種のみ指定可） | 必須 | - | - |
| LAYER | 階層情報 | 階層情報※6（カンマ区切り、ワイルドカード `*` 指定可） | - | 必須 | - |
| FREQUENCY | 期種※7 | `CY` `FY` `CH` `FH` `Q` `M` `W` `D` | - | 必須 | - |
| STARTDATE | 開始期※8 | 暦年/年度: `YYYY`、暦年半期/年度半期: `YYYYHH`※9、四半期: `YYYYQQ`※9、月次/週次/日次: `YYYYMM`※9※10 | 任意 | 任意 | - |
| ENDDATE | 終了期※8 | STARTDATEと同形式 | 任意 | 任意 | - |
| STARTPOSITION | 検索開始位置※11 | 1以上の整数 | 任意 | 任意 | - |

注記:

- ※1 以下の文字および全角文字は指定不可: `< > ” ! | \ ; '`
- ※2 「必須」は指定必須、「任意」は省略可能、「-」は指定不可。
- ※3 エラー時は指定形式にかかわらずJSONでエラー内容を出力。
- ※4 DB名は [付録A](./appendix-db-list.md) を参照。
- ※5 系列コードは系列特定用の固有コード（例: `MADR1Z@D`）。データコード（例: `IR01'MADR1Z@D`）を指定するとエラー。系列コードは全て同一期種で指定する必要あり。
- ※6 階層情報の指定方法は本章「(3) 階層情報」を参照。
- ※7 週次には `W0`〜`W6` が存在するが、指定時はすべて `W` を指定。階層APIでは複数週次をまとめて出力しうる。コードAPIでは期種混在不可（例: `W1` と `W4` を同時指定不可）。
- ※8 開始期未指定時は収録開始期から、終了期未指定時は収録終了期まで出力。
- ※9 `HH=01/02`、`QQ=01-04`、`MM=01-12`。
- ※10 週次・日次は月次形式（`YYYYMM`）で指定。
- ※11 検索開始位置の詳細は本章「4. 制限値」を参照。

### (2) DB名

DB名とDB名称の対応は [付録A: DB名一覧](./appendix-db-list.md) を参照してください。

### (3) 階層情報

データ系列メタ情報には、系列名称等に加えて、データ系列をツリー構造で整理した階層情報があります。階層情報は5階層（階層1〜5）で管理されます。

例（DB: 資金循環 `FF`）:

| 系列名 | 系列コード | 階層1 | 階層2 | 階層3 | 階層4 | 階層5 |
|---|---|---:|---:|---:|---:|---:|
| 資金循環・四半期 |  | 1 | 0 | 0 | 0 | 0 |
| ストック |  | 1 | 1 | 0 | 0 | 0 |
| 金融機関 |  | 1 | 1 | 1 | 0 | 0 |
| 資産・現金・預金／金融機関／ストック | `FOF_FFAS100A100` | 1 | 1 | 1 | 1 | 0 |
| 資産・-現金／金融機関／ストック | `FOF_FFAS100A110` | 1 | 1 | 1 | 2 | 0 |
| 資産・-日銀預け金／金融機関／ストック | `FOF_FFAS100A120` | 1 | 1 | 1 | 3 | 0 |
| ... |  |  |  |  |  |  |

階層APIの指定ルール:

- 階層1の指定は必須。
- 階層2〜5は任意。
- 複数階層はカンマ `,` 区切りで指定。
- `*` は当該階層を全件対象とするワイルドカード。

## 4. 制限値
> 出典: api_manual.pdf p.9-p.11

### (1) 制限値

| APIの種類 | 制限内容 | 上限値 | 上限値を超えた場合 |
|---|---|---:|---|
| 階層API | 検索条件で抽出される系列数（系列コード数）※1 | 1,250件 | エラー。出力ファイルは作成されない。 |
| コードAPI / 階層API | 1回のリクエストで検索可能な系列数 | 250件 | 上限値まで出力し、続き検索用の `NEXTPOSITION` を出力。 |
| コードAPI / 階層API | 1回のリクエストで検索可能なデータ数（系列数×期数）※2 | 60,000件 | 上限値まで出力し、続き検索用の `NEXTPOSITION` を出力。 |

注記:

- ※1 階層APIの系列数は、期種絞り込み前の段階で数えるため、指定外期種も合計に含まれる。
- ※2 データがない場合の `null` もデータ数に含める。
- ※3 系列数またはデータ数のどちらかが上限を超えた場合、上限値まで出力。
- ※4 `NEXTPOSITION` の使い方は「(2) 検索開始位置」を参照。

### (2) 検索開始位置

`STARTPOSITION` を利用すると、上限超過時に続きから検索できます。

共通動作:

- 上限超過時、レスポンスの `NEXTPOSITION` に数値が出力される。
- 次回リクエストで `STARTPOSITION=<NEXTPOSITIONの値>` を指定すると、続きから取得できる。
- `NEXTPOSITION` が未出力の場合、全データ取得済み。

コードAPI:

- 指定した系列コードの並び順が検索開始位置番号として使われる。
- 例: `STARTPOSITION=160` を指定すると、160番目のコード以降を取得。

階層API:

- DB内全系列を階層1〜5で並べ替えた順序番号が検索開始位置番号になる。
- 絞り込み結果だけに振られた番号ではない点に注意。
- 例: `db=MD10&frequency=Q&layer=*&startPosition=255`

### (3) 制限値を超える系列数を取得する場合のリクエスト方法

大量系列を取得する場合は、事前にメタデータAPIでメタ情報を取得したうえで実施することが推奨されています。繰り返し処理では高頻度アクセスを避け、間隔を空けてください。

コードAPI利用時:

1. 系列コードを250件指定して検索（全件同一期種）。
2. `NEXTPOSITION` がある場合、同条件に `STARTPOSITION` を付けて続き検索。
3. `NEXTPOSITION` が消えるまで2を繰り返す。
4. 次の250件ブロックで1〜3を繰り返す。

階層API利用時:

1. 階層情報で絞り込んだ系列数が1,250件以内になるよう分割設計。
2. 分割した階層情報で検索。
3. `NEXTPOSITION` を使って続き検索。
4. `NEXTPOSITION` が消えるまで3を繰り返す。
5. 別の階層情報分割について2〜4を繰り返す。
