# BOJ APIクライアント バージョン管理設計（Design Spec）

- 作成日: 2026-02-19
- 対象リポジトリ: `boj-client`
- ステータス: Draft（方針案）
- 本書の目的: 日銀APIの将来仕様変更に備え、クライアント側のバージョン管理方針と公開インターフェース方針を定義する
- 本書の範囲: 設計ドキュメント作成のみ（実装コード変更は別タスク）

## 0. 前提の明確化

- 2026-02-19時点で、日銀APIの公式なバージョニング方針および廃止方針は公表されていない。
- 本書は、将来日銀APIで複数バージョン運用が導入された場合に適用するクライアント設計の方針案である。
- 日銀の公式方針が公表された場合は `docs/api-manual` を一次情報として優先し、本書を追従更新する。

## 1. 背景と目的

日銀APIで将来的に `Version A`/`Version B` のような複数バージョン併存が発生しうる。  
このとき利用者が毎回バージョン差分を直接吸収すると、クライアント利用コストと移行コストが増大する。

本設計は以下を目的とする。

- 利用者の主要導線を安定化し、日常利用ではバージョン差分を意識させない
- 差分が必要な場面だけ版別インターフェースへ降りられるようにする
- 既存版を即時廃止しない運用を暫定デフォルトとし、利用者の移行タイミングを過度に強制しない

## 2. スコープ/非スコープ

### 2.1 スコープ

- 公開インターフェース方針（ハイブリッド構成）
- 版別実装の責務分離方針（adapter分離）
- 互換性ポリシーとSemVer運用方針
- エラーハンドリングの共通契約方針
- 移行ガイドラインおよび検証観点

### 2.2 非スコープ

- 実装コードの追加・変更
- 最終的な言語別シグネチャ確定（Rustの具体型定義を含む）
- CI設定・ベンチマーク・運用インフラの実装

### 2.3 前提とデフォルト

- 公開戦略はハイブリッド（共通Facade + 版別名前空間）
- バージョン運用の暫定デフォルトは「恒久併存志向（旧版を即廃止しない）」とする
- ただし日銀の公式バージョニング/廃止方針が公表された場合は、公式方針を優先する
- 本書は方針中心とし、実装詳細は別タスクで確定する
- 公式仕様の一次参照は `docs/api-manual` とする

## 3. 用語定義

| 用語 | 定義 |
|---|---|
| 共通Facade | 利用者の第一導線となる安定公開インターフェース。版差分を内部吸収する。 |
| 版別インターフェース | `client.version_a.*`/`client.version_b.*` などの名前空間で公開する版固有API（概念名）。差分を明示的に扱う用途。 |
| 正規化モデル | バージョン差分を吸収した共通レスポンス表現。 |
| Adapter | 各APIバージョンのレスポンスを正規化モデルへ変換する内部コンポーネント。 |
| Extension/Raw領域 | 版固有フィールドや未正規化データを退避する拡張領域。 |
| 恒久併存（暫定） | 日銀公式方針が未公表の間、既存版を即時廃止せず継続提供する暫定デフォルト方針。 |
| 影響分類 | 変更を「非破壊追加」「意味変更」「破壊変更」に分ける管理ルール。 |

## 4. 公開インターフェース戦略

### 4.1 二層公開モデル

公開インターフェースは次の2層で提供する。

- 第一導線: `client.<stable-domain>.*`（共通Facade）
- 第二導線: `client.version_a.*` / `client.version_b.*`（版別インターフェース、いずれも概念名）

利用者は原則として共通Facadeを利用し、版固有要件がある場合のみ版別インターフェースを選択する。  
`version_a`/`version_b` は説明のための抽象名であり、実装時の最終命名は別タスクで確定する。

### 4.2 利用経路の判断表

| 状況 | 推奨経路 | 理由 |
|---|---|---|
| 共通項目のみで要件を満たせる | 共通Facade | 版差分の影響を最小化できる |
| 特定バージョン固有項目が必要 | 版別インターフェース | 仕様差分を明示的に扱える |
| 外部契約でバージョン固定が必要 | 版別インターフェース | 監査・再現性要件を満たしやすい |
| 将来の版追加に備えたい | 共通Facade | 利用側変更を抑制できる |

### 4.3 バージョン選択規約

- 共通Facadeは `ClientConfig.default_version`（概念名）で実行バージョンを決定する
- デフォルトバージョンは暗黙に変更しない（マイナー/パッチで自動切替しない）
- 新バージョン追加時は、利用者の明示設定がない限り既存挙動を維持する
- 将来メジャー改定でデフォルトを変更する場合は、互換性変更として扱いリリースノートで明示する
- 日銀の公式方針がデフォルト選択や廃止期限を定義した場合は、その方針を優先する

### 4.4 規約（禁止/推奨/例外条件）

| 区分 | 規約 |
|---|---|
| 禁止事項 | 共通Facadeに版固有フィールドを必須項目として露出しない |
| 推奨事項 | 新規利用者はまず共通Facadeを採用し、必要時のみ版別インターフェースを追加する |
| 例外条件 | 法令・監査・外部接続要件により版固定が必須の場合は版別インターフェースを第一導線としてよい |

## 5. バージョン別実装方針

### 5.1 責務分離

- `Version A`/`Version B` ごとにadapterを分離し、版差分の吸収責務をadapterに限定する
- 共通Facadeは正規化モデルの返却責務のみを持つ
- 版別インターフェースは版固有機能をそのまま公開し、正規化は任意とする

### 5.2 正規化レスポンス契約

共通Facadeが返す正規化モデルは、利用者が依存してよい最小共通契約を提供する。

- 共通必須: 系列識別子、時点、値、更新時刻、エラー情報
- 共通任意: 言語依存ラベル、補足メタ情報
- 版固有情報: `extensions` または `raw` 相当領域へ退避

### 5.3 版固有情報の取り扱い

- 版固有フィールドは共通モデルへ無理に昇格しない
- 利用者が版固有情報を必要とする場合は、版別インターフェースまたは拡張領域を参照する
- 共通化候補は複数版で意味が一致することを確認してから昇格する

### 5.4 参考ディレクトリ構成（概念）

```text
src/
  facade/              # 共通Facade層
  adapters/
    version_a/         # Version Aレスポンス変換
    version_b/         # Version Bレスポンス変換
  model/
    normalized/        # 共通契約モデル
    versioned/         # 版別モデル
```

### 5.5 規約（禁止/推奨/例外条件）

| 区分 | 規約 |
|---|---|
| 禁止事項 | adapter間で共通化されていない変換ロジックをFacade層へ持ち込まない |
| 推奨事項 | 変換責務は「取得」「変換」「返却」で分離し、版差分はadapter内で完結させる |
| 例外条件 | 公式仕様変更が全バージョンに同時適用される場合のみ、共通ユーティリティ化を許可する |

## 6. 互換性ポリシー

### 6.1 恒久併存方針（暫定デフォルト）

- 日銀公式方針が未公表の間は、`Version A` と `Version B` の併存提供を前提に設計する
- 非推奨注記は可能だが、即時廃止を前提とした運用は行わない
- 日銀が廃止期限や移行規則を公表した場合は、公式方針を優先し、本書と移行ガイドを更新する

### 6.2 影響分類とSemVer運用

| 影響分類 | 例 | リリース種別 | 取り扱い |
|---|---|---|---|
| 非破壊追加 | 任意フィールド追加、メソッド追加 | Minor | 既存利用者の挙動を変えない |
| 意味変更 | 同名項目の意味変更、既定値変更 | Major | 互換性変更として扱い、移行手順を必須化 |
| 破壊変更 | 必須項目削除、既存API削除/改名 | Major | 共通Facadeでは回避策を先に提供し、段階移行を示す |

### 6.3 規約（禁止/推奨/例外条件）

| 区分 | 規約 |
|---|---|
| 禁止事項 | Minor/Patchで既定バージョンを暗黙変更しない |
| 推奨事項 | 影響分類をPR/リリースノートに明示し、利用者の判断コストを下げる |
| 例外条件 | セキュリティ修正や日銀公式方針への緊急追従が必要な場合は挙動変更を許可するが、変更内容と回避策を同時公開する |

## 7. エラーハンドリング方針

### 7.1 共通エラー契約

利用者向けには次の共通エラー情報を提供する。

| 項目 | 内容 |
|---|---|
| status | API処理結果ステータス（例: 200/400/500/503） |
| message_id | APIメッセージID |
| message | APIメッセージ本文 |
| date | API応答日時（またはデータ作成日時） |
| source_version | エラー発生元バージョン（例: Version A / Version B） |
| raw | 元レスポンス（解析不能時の調査用） |

### 7.2 BOJ APIステータスの標準化

| STATUS | 標準化カテゴリ | 意味 |
|---|---|---|
| 200 | Success | 正常終了 |
| 400 | InvalidRequest | パラメータ不備 |
| 500 | InternalError | 予期せぬエラー |
| 503 | ServiceUnavailable | DBアクセス系エラー |

### 7.3 解析ルール

- フォーマット指定がCSVでも、エラー時はJSONが返る前提で処理する
- `STATUS != 200` の場合、データ部は存在しない前提でエラー処理へ分岐する
- 解析不能時でも `raw` を保持し、調査可能性を確保する

### 7.4 規約（禁止/推奨/例外条件）

| 区分 | 規約 |
|---|---|
| 禁止事項 | 版ごとに異なるエラー型をそのまま利用者へ露出しない |
| 推奨事項 | エラー契約は共通化し、版差分は `source_version` と `raw` で補完する |
| 例外条件 | 通信層障害やタイムアウトなどAPI応答を得られないケースは、共通契約外の輸送エラーとして扱う |

## 8. 移行ガイドライン

### 8.1 共通Facade導入手順

1. 現行利用箇所を「共通要件」と「版固有要件」に分類する
2. 共通要件を共通Facadeへ移し、版固有要件のみ版別インターフェースを残す
3. 版固有依存を `extensions`/`raw` 参照に限定する
4. 契約テストで共通要件の挙動一致を確認する

### 8.2 複数バージョン併用時のルール（将来想定）

- 同一アプリ内で `Version A` と `Version B` を併用してよい
- ただし1ユースケース内では版の責務境界を明示し、暗黙変換を禁止する
- 将来の版追加時は同じ境界規則を踏襲する

### 8.3 規約（禁止/推奨/例外条件）

| 区分 | 規約 |
|---|---|
| 禁止事項 | 移行途中に共通Facadeと版別インターフェースの返却契約を混在依存しない |
| 推奨事項 | まず共通Facadeへ寄せてから、必要箇所のみ版別機能を段階追加する |
| 例外条件 | 既存外部契約により全体を版固定する必要がある場合は、その契約単位で版別インターフェースを維持する |

## 9. テスト/検証方針

### 9.1 必須シナリオ

1. 同一ユースケースを `Version A` と `Version B` で呼び出した際、Facade返却の必須共通項目が同一契約を満たす。
2. 版固有項目がFacade必須項目に漏れず、版別インターフェースまたは拡張領域でのみ参照される。
3. エラー時に共通エラー契約が一貫して扱える（フォーマット指定差異を含む）。
4. `Version A`/`Version B` を同一アプリで同時利用しても、利用者コードの責務境界が崩れない。
5. 新版追加時に既存Facade利用者へ破壊的影響を出さない（既存契約維持）。
6. ドキュメント検証として、各規約に「禁止事項」「推奨事項」「例外条件」が明記されている。

### 9.2 テストレイヤー

| レイヤー | 主目的 | 最低限の確認内容 |
|---|---|---|
| 契約テスト | 共通Facade契約の維持 | 共通必須項目、既定挙動、版選択規約 |
| adapterテスト | 版差分吸収の妥当性 | Version A/Version B変換、拡張領域退避、欠損時の挙動 |
| エラーテスト | 失敗時契約の一貫性 | STATUS別マッピング、CSV指定時JSONエラー処理 |
| ドキュメントテスト | 設計の完全性 | 章欠落、用語不整合、規約ラベル有無 |

### 9.3 ドキュメント品質チェックリスト

- [ ] 章立てが本書の固定順序どおりである
- [ ] 用語定義と本文で名称ゆれがない
- [ ] 共通Facadeと版別IFの責務境界が明記されている
- [ ] 恒久併存が暫定デフォルト方針であり、公式方針優先であることが明記されている
- [ ] 影響分類とSemVer運用が明記されている
- [ ] 各方針に禁止事項・推奨事項・例外条件がある

## 10. 運用ルール（リリース・変更管理）

### 10.1 リリース時の必須更新

- 影響分類（非破壊追加/意味変更/破壊変更）を変更記録へ記載する
- 共通Facadeに影響がある場合は移行ガイドを更新する
- 新バージョン追加時は版別インターフェースとテスト観点を追記する

### 10.2 変更管理プロセス

1. 仕様変更の一次情報を `docs/api-manual` で確認する
2. 日銀の公式バージョニング/廃止方針の有無を確認する
3. 公式方針がある場合はそれを優先し、本書の該当章（2.3、6.1、8.2、9.3）を先に更新する
4. 影響分類を実施し、共通Facade影響有無を判断する
5. 実装タスクを別チケットとして起票する

### 10.3 規約（禁止/推奨/例外条件）

| 区分 | 規約 |
|---|---|
| 禁止事項 | 公式仕様差分の確認なしに共通契約を変更しない |
| 推奨事項 | 「仕様反映」→「設計更新」→「実装」の順で変更を進める |
| 例外条件 | 緊急障害対応で先に実装修正が必要な場合は、同一リリース内で設計書追補を必須とする |

## 11. 実装メモ（v0.2.0）

### 11.1 モジュール公開方針

- v0.2.0 でルート直下 re-export を廃止し、用途別名前空間に再編した
- 主な公開入口:
  - `client::BojClient`
  - `query::{CodeQuery, LayerQuery, MetadataQuery, Format, Language, Frequency}`
  - `model::*`（レスポンス型）
  - `decode` / `transport` / `retry` は内部実装として非公開化

### 11.2 src責務分割

- `decode` は `json`/`csv`/`common` に分割し、巨大単一ファイルを解消した
- `query` は `code`/`layer`/`metadata`/`options`/`validation` に分割した
- `client` は `core`/`http`/`response` に分割し、通信前処理と応答後処理を分離した
